
.. _tutorials:

Tutorials
=========

**nwb2bids** comes pre-packaged with some demonstrative tools to help showcase its functionality on various types of
NWB file contents. No additional requirements, knowledge, or experience are necessary to run these tutorials!

These tutorials demonstrates how to convert NWB file(s) into a BIDS directory structure. Each action allows for
alternative use cases based on the command line interface (CLI) or the Python library.

All of the tutorials on this page will utilize the example NWB files produced from :ref:`generate-example-file` and
:ref:`generate-example-dataset`. You can, of course, feel free to utilize your own NWB files, but the resulting
output may appear different than what is shown through the generated examples.



.. _generate-example-file:

Generating an example NWB file
------------------------------

In case you don't have any NWB files handy, or perhaps you've never worked with NWB files before, you can generate
an example file by running:

.. tabs::
    .. tab:: CLI

        .. code-block:: bash

            nwb2bids tutorial ephys file

    .. tab:: Python Library

        .. code-block:: python

            >>> import nwb2bids
            >>>
            >>> tutorial_file = nwb2bids.testing.generate_ephys_tutorial(mode="file")


This created an NWB file with contents typical of an extracellular electrophysiology experiment in your home
directory for **nwb2bids**: ``~/nwb2bids_tutorials/ephys_tutorial_file/ephys.nwb``.

NWB files like these contain a lot of metadata about the probes and electrode structure, which will be useful later
when we compare the source file to the sidecar tables found in BIDS. You can explore these file contents through
`neurosift.app <neurosift.app>`_ by following `this link <https://neurosift.app/nwb?url=https://api.sandbox.dandiarchive.org/api/assets/687b0e17-b3b5-4bbc-8797-3cc2ab4955f5/download/&dandisetId=217739&dandisetVersion=draft>`_.

.. tip::

    The link above actually points to a similar file published on the DANDI Archive, which should be identical to
    what was created on your system. You can explore and visualize your local file contents and structure
    in many other ways, such as the
    `NWB GUIDE <https://nwb-guide.readthedocs.io/en/stable/installation.html>`_,
    `HDFView <https://www.hdfgroup.org/download-hdfview/>`_, or the
    `PyNWB library <https://pynwb.readthedocs.io/en/stable/tutorials/general/plot_read_basics.html#reading-and-exploring-an-nwb-file>`_.

    If you ever upload your own NWB files to DANDI or EMBER, you too can share Neurosift links with your collaborators!


.. _generate-example-dataset:

Generating an example dataset
-----------------------------

In case you don't have an entire experiment's worth of NWB files, you can generate an example dataset by running:

.. tabs::
    .. tab:: CLI

        .. code-block:: bash

            nwb2bids tutorial ephys dataset

        .. tip::

            Lost in the CLI? Can't remember the exact phrase to type when navigating through the command groups? No worries!

            Simply add the ``--help`` to any command to see detailed descriptions, expected inputs, and optional flags.

            You can also see a layout of the command structure by calling each level at a time, for example ``nwb2bids``,
            ``nwb2bids tutorial``, and so on.

            Try it out on ``nwb2bids tutorial`` to see all the types of tutorial data we can generate for you.

    .. tab:: Python Library

        .. code-block:: python

            >>> import nwb2bids
            >>>
            >>> tutorial_directory = nwb2bids.testing.generate_ephys_tutorial(
            ...     mode="dataset"
            ... )

        .. tip::

            Lost in the Python library? Can't remember the exact inputs to pass to an imported function? No worries!

            Simply add the ``?`` at the end of any module or function to see a detailed description of imports or
            expected inputs. Try it out on ``nwb2bids?`` to see the library's welcome message.

            The **nwb2bids** library is also designed for easy auto-completion in interactive environments like
            IPython or Jupyter notebooks; try it out on by hitting your tab button after typing ``nwb2bids.testing.`` to
            see all the functions exposed to that submodule.

Now we should have a directory that looks something like:

.. code-block:: text

    ephys_tutorial_dataset/
    ├── ephys_session_3.nwb
    ├── DO_NOT_CONVERT.nwb
    └── some_sessions/
        ├── ephys_session_1.nwb
        └── ephys_session_1.nwb

.. note::

    Don't like overwhelming your home directory with lots of small files?

    .. tabs::
        .. tab:: CLI

            You can control where tutorial data is generated by using the ``--output-directory`` flag (or ``-o`` for
            short):

            .. code-block:: bash

                nwb2bids tutorial ephys file --output-directory path/to/some/directory

        .. tab:: Python Library

            You can control where tutorial data is generated by using the ``output_directory`` keyword argument:

            .. code-block:: python

                >>> import nwb2bids
                >>>
                >>> tutorial_directory = nwb2bids.testing.generate_ephys_tutorial(
                ...     mode="file",
                ...     output_directory=path_to_some_directory,
                ... )



.. _tutorial-single-file:

Tutorial 1 - Converting a single file
-------------------------------------

To convert a single NWB file to BIDS dataset structure, we run the following command:

.. tabs::
    .. tab:: CLI

        .. code-block:: bash

            cd ~/nwb2bids_tutorials/ephys_tutorial_file

            nwb2bids convert ephys.nwb --bids-directory bids_dataset_1

    .. tab:: Python Library

        .. code-block:: python

            >>> import pathlib
            >>>
            >>> import nwb2bids
            >>>
            >>> tutorial_directory = pathlib.Path.home() / "nwb2bids_tutorials/ephys_tutorial_file"
            >>> nwb_paths = [tutorial_directory / "ephys.nwb"]
            >>> bids_directory = tutorial_directory / "bids_dataset_1"
            >>> bids_directory.mkdir(exist_ok=True)
            >>>
            >>> run_config = nwb2bids.RunConfig(bids_directory=bids_directory)
            >>> converter = nwb2bids.convert_nwb_dataset(
            ...     nwb_paths=nwb_paths,
            ...     run_config=run_config,
            ... )

Notice how we explicitly specified the output BIDS directory in the previous step. We will cover the implicit
(current working directory) approach in  :ref:`tutorial-implicit-bids-directory`.

You can now explore the directory structure and contents of the generated BIDS dataset. You should see something
along the lines of:

.. code-block:: text

    ephys_tutorial_file/bids_dataset_1/
    ├── dataset_description.json
    ├── participants.tsv
    ├── participants.json
    └── sub-001/
        ├── sub-001_sessions.tsv
        ├── sub-001_sessions.json
        └── ses-A/
            └── ecephys/
                ├── sub-001_ses-A_ecephys.nwb
                ├── sub-001_ses-A_channels.tsv
                ├── sub-001_ses-A_channels.json
                ├── sub-001_ses-A_electrodes.tsv
                ├── sub-001_ses-A_electrodes.json
                ├── sub-001_ses-A_probes.tsv
                └── sub-001_ses-A_probes.json



.. _tutorial-multiple-files:

Tutorial 2 - Converting directories
-----------------------------------

To convert all of the NWB files under a directory to BIDS, we can run the following command:

.. tabs::
    .. tab:: CLI

        .. code-block:: bash

            cd ~/nwb2bids_tutorials/ephys_tutorial_dataset

            nwb2bids convert some_sessions --bids-directory bids_dataset_2

    .. tab:: Python Library

        .. code-block:: python

            >>> import pathlib
            >>>
            >>> import nwb2bids
            >>>
            >>> tutorial_directory = pathlib.Path.home() / "nwb2bids_tutorials/ephys_tutorial_dataset"
            >>> nwb_paths = [tutorial_directory / "some_sessions"]
            >>> bids_directory = tutorial_directory / "bids_dataset_2"
            >>> bids_directory.mkdir(exist_ok=True)
            >>>
            >>> run_config = nwb2bids.RunConfig(bids_directory=bids_directory)
            >>> converter = nwb2bids.convert_nwb_dataset(
            ...     nwb_paths=nwb_paths,
            ...     run_config=run_config,
            ... )

And our BIDS dataset should look like:

.. code-block:: text

    ephys_tutorial_dataset/bids_dataset_2/
    ├── dataset_description.json
    ├── participants.tsv
    ├── participants.json
    └── sub-001/
        ├── sub-001_sessions.tsv
        ├── sub-001_sessions.json
        ├── ses-A/
        │   └── ecephys/
        │       ├── sub-001_ses-A_ecephys.nwb
        │       ├── sub-001_ses-A_channels.tsv
        │       ├── sub-001_ses-A_channels.json
        │       ├── sub-001_ses-A_electrodes.tsv
        │       ├── sub-001_ses-A_electrodes.json
        │       ├── sub-001_ses-A_probes.tsv
        │       └── sub-001_ses-A_probes.json
        └── ses-B/
            └── ecephys/
                ├── sub-001_ses-B_ecephys.nwb
                ├── sub-001_ses-B_channels.tsv
                ├── sub-001_ses-B_channels.json
                ├── sub-001_ses-B_electrodes.tsv
                ├── sub-001_ses-B_electrodes.json
                ├── sub-001_ses-B_probes.tsv
                └── sub-001_ses-B_probes.json



.. _tutorial-multiple-inputs:

Tutorial 3 - Multiple inputs
----------------------------

Using the example dataset generated in :ref:`generate-example-dataset`, we will now show how to convert any mix of
individual NWB files and directories containing NWB files.

Attentive readers may have noticed that in :ref:`tutorial-multiple-files`, we only converted the files under
``some_sessions/`` while ignoring the other NWB file at the top level (including the one called ``DO_NOT_CONVERT.nwb``).

We can select which files and directories to convert like so:

.. tabs::
    .. tab:: CLI

        .. tabs::
            .. tab:: Unix / macOS

                .. code-block:: bash

                    cd ~/nwb2bids_tutorials/ephys_tutorial_dataset

                    nwb2bids convert ephys_session_3.nwb some_sessions \
                        --bids-directory bids_dataset_3

            .. tab:: Windows

                .. code-block:: bash

                    cd ~/nwb2bids_tutorials/ephys_tutorial_dataset

                    nwb2bids convert ephys_session_3.nwb some_sessions ^
                        --bids-directory bids_dataset_3

        The command line can take any number of inputs (separated by spaces) prior to other flags such as
        ``--bids-directory``. Shell globs, such as ``*.nwb``, could be used as shown in
        section :ref:`tutorial-implicit-bids-directory`. These inputs can be any mix of files or directories.

    .. tab:: Python Library

        .. code-block:: python

            >>> import pathlib
            >>>
            >>> import nwb2bids
            >>>
            >>> tutorial_directory = pathlib.Path.home() / "nwb2bids_tutorials/ephys_tutorial_dataset"
            >>> nwb_paths = [
            ...     tutorial_directory / "ephys_session_3.nwb",
            ...     tutorial_directory / "some_sessions",
            ... ]
            >>> bids_directory = tutorial_directory / "bids_dataset_3"
            >>> bids_directory.mkdir(exist_ok=True)
            >>>
            >>> run_config = nwb2bids.RunConfig(bids_directory=bids_directory)
            >>> converter = nwb2bids.convert_nwb_dataset(
            ...     nwb_paths=nwb_paths,
            ...     run_config=run_config,
            ... )

Our resulting BIDS dataset should now contain all three NWB files converted to BIDS:

.. code-block:: text

    ephys_tutorial_dataset/bids_dataset_3/
    ├── dataset_description.json
    ├── participants.tsv
    ├── participants.json
    ├── sub-001/
    │   ├── sub-001_sessions.tsv
    │   ├── sub-001_sessions.json
    │   ├── ses-A/
    │   │   └── ecephys/
    │   │       ├── sub-001_ses-A_ecephys.nwb
    │   │       ├── sub-001_ses-A_channels.tsv
    │   │       ├── sub-001_ses-A_channels.json
    │   │       ├── sub-001_ses-A_electrodes.tsv
    │   │       ├── sub-001_ses-A_electrodes.json
    │   │       ├── sub-001_ses-A_probes.tsv
    │   │       └── sub-001_ses-A_probes.json
    │   └── ses-B/
    │       └── ecephys/
    │           ├── sub-001_ses-B_ecephys.nwb
    │           ├── sub-001_ses-B_channels.tsv
    │           ├── sub-001_ses-B_channels.json
    │           ├── sub-001_ses-B_electrodes.tsv
    │           ├── sub-001_ses-B_electrodes.json
    │           ├── sub-001_ses-B_probes.tsv
    │           └── sub-001_ses-B_probes.json
    └── sub-002/
        ├── sub-002_sessions.tsv
        ├── sub-002_sessions.json
        └── ses-C/
            └── ecephys/
                ├── sub-002_ses-C_ecephys.nwb
                ├── sub-002_ses-C_channels.tsv
                ├── sub-002_ses-C_channels.json
                ├── sub-002_ses-C_electrodes.tsv
                ├── sub-002_ses-C_electrodes.json
                ├── sub-002_ses-C_probes.tsv
                └── sub-002_ses-C_probes.json



.. _tutorial-implicit-bids-directory:

Tutorial 4 - Implicit BIDS directory
------------------------------------

In the previous tutorials we have always specified the target BIDS directory as an explicit path. It is also possible
to use the current working directory as the BIDS directory, provided that it is either empty or already a partial BIDS
dataset as defined by a ``dataset_description.json`` file with a ``BIDSVersion`` value specified within.

To test this out, we can create a new empty directory and navigate into it before converting:

.. tabs::
    .. tab:: CLI

        .. code-block:: bash

            cd ~/nwb2bids_tutorials/ephys_tutorial_dataset/
            mkdir bids_dataset_4
            cd bids_dataset_4

            nwb2bids convert ../ephys_session_3.nwb ../some_sessions/*.nwb

        The command line can take any number of inputs (separated by spaces) prior to other flags such as
        ``--bids-directory``. These inputs can be any mix of files or directories.

    .. tab:: Python Library

        .. code-block:: python

            >>> import os
            >>> import pathlib
            >>>
            >>> import nwb2bids
            >>>
            >>> tutorial_directory = pathlib.Path.home() / "nwb2bids_tutorials/ephys_tutorial_dataset"
            >>> nwb_paths = [
            ...     tutorial_directory / "ephys_session_3.nwb",
            ...     tutorial_directory / "some_sessions",
            ... ]
            >>> bids_directory = tutorial_directory / "bids_dataset_4"
            >>> bids_directory.mkdir(exist_ok=True)
            >>> os.chdir(path=bids_directory)
            >>>
            >>> converter = nwb2bids.convert_nwb_dataset(nwb_paths=nwb_paths)
            assert len(converter.session_converters) == 3
            assert len(converter.messages) == 0

And the results should match what we saw at the end of :ref:`tutorial-multiple-inputs`, except that we operated
entirely from within ``bids_dataset_4``.



.. _tutorial-additional-metadata:

Tutorial 5 - Additional metadata
---------------------------------

NWB files don't always include all the little metadata details you might want to include in BIDS. To include manual
metadata that is absent in the source files, you can provide additional metadata through a simple JSON
structure shown below.

.. note::

    Currently only ``dataset_description`` metadata is supported, but more detailed subject- and session-level
    metadata will be supported in the future.

To show how such additional metadata can be included through **nwb2bids**, start by creating a file named
``metadata.json`` inside the ``ephys_tutorial_dataset`` directory we used in :ref:`tutorial-multiple-files`.
Then fill the contents of the file to match below:

.. code-block:: json

    {
        "dataset_description": {
            "Name": "My Custom BIDS Dataset",
            "BIDSVersion": "1.8.0",
            "Authors": ["Last, First"]
        }
    }

To include this additional metadata during conversion, we can use the following commands:

.. tabs::
    .. tab:: CLI

        .. tabs::
            .. tab:: Unix / macOS

                .. code-block:: bash

                    cd ~/nwb2bids_tutorials/ephys_tutorial_file

                    nwb2bids convert ephys.nwb \
                        --bids-directory bids_dataset_5 \
                        --additional-metadata-file-path metadata.json

            .. tab:: Windows

                .. code-block:: bash

                    cd ~/nwb2bids_tutorials/ephys_tutorial_file

                    nwb2bids convert ephys.nwb ^
                        --bids-directory bids_dataset_5 ^
                        --additional-metadata-file-path metadata.json

    .. tab:: Python Library

        .. code-block:: python

            >>> import pathlib
            >>>
            >>> import nwb2bids
            >>>
            >>> tutorial_directory = pathlib.Path.home() / "nwb2bids_tutorials/ephys_tutorial_file"
            >>> nwb_paths = [tutorial_directory / "ephys.nwb"]
            >>> bids_directory = tutorial_directory / "bids_dataset_5"
            >>> bids_directory.mkdir(exist_ok=True)
            >>> additional_metadata_file_path = tutorial_directory / "metadata.json"
            >>>
            >>> run_config = nwb2bids.RunConfig(
            ...     bids_directory=bids_directory,
            ...     additional_metadata_file_path=additional_metadata_file_path,
            ... )
            >>> converter = nwb2bids.convert_nwb_dataset(
            ...     nwb_paths=nwb_paths,
            ...     run_config=run_config,
            ... )



.. _tutorial-library-customization:

Tutorial 6 - Library customization
----------------------------------

The **nwb2bids** Python library is much easier to customize and interact with than the CLI usage.

The workflow that is automatically run by the helper function :func:`~nwb2bids.convert_nwb_dataset()` can be
broken down into the following distinct steps:

.. code-block:: python

    >>> import nwb2bids
    >>>
    >>> tutorial_directory = pathlib.Path.home() / "nwb2bids_tutorials/ephys_tutorial_file"
    >>> nwb_paths = [tutorial_directory / "ephys.nwb"]
    >>> bids_directory = tutorial_directory / "bids_dataset_6"
    >>> bids_directory.mkdir(exist_ok=True)
    >>> additional_metadata_file_path = tutorial_directory / "metadata.json"
    >>>
    >>> # Step 1: Initialize the DatasetConverter object
    >>> run_config = nwb2bids.RunConfig(
    ...     bids_directory=bids_directory,
    ...     additional_metadata_file_path=additional_metadata_file_path,
    ... )
    >>> converter = nwb2bids.DatasetConverter.from_nwb_paths(
    ...     nwb_paths=nwb_paths,
    ...     run_config=run_config,
    ... )
    >>>
    >>> # Step 2: Extract metadata from NWB contents
    >>> converter.extract_metadata()
    >>>
    >>> # Step 3: Convert NWB files to BIDS structure
    >>> converter.convert_to_bids_dataset()

The ``converter`` object (a type of :class:`~nwb2bids.DatasetConverter`) exposes many useful attributes and methods
that may useful to explore. In particular, it contains all of the :class:`~nwb2bids.SessionConverter` objects that were
assembled from the input NWB files. These in turn attach various metadata models,
such as :class:`~nwb2bids.bids_models.BidsSessionMetadata`, from which all metadata attributes used during the BIDS
conversion process may be inspected and modified prior to writing the resulting files.



.. _tutorial-future:

More tutorials coming soon!
---------------------------

We are still compiling some detailed tutorials for more advanced use cases, such as sanitization, run configurations,
non-ephys data types, and more!

Check back soon for updates.
