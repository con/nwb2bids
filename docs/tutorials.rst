
.. _tutorials:

Tutorials
=========

**nwb2bids** comes pre-packaged with some demonstrative tools to help showcase its functionality on various types of
NWB file contents. No additional requirements, knowledge, or experience are necessary to run these tutorials!

These tutorials demonstrates how to convert NWB file(s) into a BIDS directory structure. Each action allows for
alternative use cases based on the command line interface (CLI) or the Python library.



.. _tutorial-single-file:

Tutorial 1 - Converting a single file
-------------------------------------

In case you don't have any NWB files handy, or perhaps you've never worked with NWB files before, you can generate a
toy example through the following methods:

.. tabs::

    .. tab:: CLI

        .. code-block:: bash

            nwb2bids tutorial ephys file

    .. tab:: Python Library

        .. code-block:: bash

            >>> import nwb2bids
            >>>
            >>> tutorial_file = nwb2bids.testing.generate_ephys_tutorial(mode="file")


This created an NWB file with contents typical of an extracellular electrophysiology experiment in your home
directory for **nwb2bids**: ``~/.nwb2bids/tutorials/ephys/nwb2bids_tutorial_ephys.nwb``.

.. note::

    Don't like overwhelming your home directory with lots of small files?

    .. tabs::

        .. tab:: CLI

            You can control where tutorial data is generated by using the ``--output-directory`` flag (or ``-o`` for
            short):

            .. code-block:: bash

                nwb2bids tutorial generate ephys --output-directory path/to/some/directory

        .. tab:: Python Library

            You can control where tutorial data is generated by using the ``output_directory`` keyword argument:

            .. code-block:: python

            >>> import nwb2bids
            >>>
            >>> tutorial_directory = nwb2bids.testing.generate_ephys_tutorial(
            ...     mode="file",
            ...     output_directory=path_to_some_directory,
            ... )


NWB files like this contain a lot of metadata about the probes and electrode structure, which will be useful later
when we compare the source file to the sidecar tables found in BIDS. You can explore these file contents through
`neurosift.app <neurosift.app>`_ by following `this link <https://neurosift.app/nwb?url=https://api.sandbox.dandiarchive.org/api/assets/687b0e17-b3b5-4bbc-8797-3cc2ab4955f5/download/&dandisetId=217739&dandisetVersion=draft>`_.

.. tip::

    The link above actually points to a similar file published on the DANDI Archive, which should be identical to
    what was created on your system. You can explore and visualize your local file contents and structure
    in many other ways, such as the
    `NWB GUIDE <https://nwb-guide.readthedocs.io/en/stable/installation.html>`_,
    `HDFView <https://www.hdfgroup.org/download-hdfview/>`_, or the
    `PyNWB library <https://pynwb.readthedocs.io/en/stable/tutorials/general/plot_read_basics.html#reading-and-exploring-an-nwb-file>`_.

    If you ever upload your own NWB files to DANDI or EMBER, you too can share Neurosift links with your collaborators!

Now that we have an NWB file, we can convert it to BIDS using the following command:

.. tabs::
    .. tab:: CLI

        .. tabs::
            .. tab:: Unix / macOS

                .. code-block:: bash

                    nwb2bids convert ~/.nwb2bids/tutorials/ephys_tutorial_file/ephys.nwb \
                        --bids-directory ~/.nwb2bids/tutorials/ephys_tutorial_file/bids_dataset

            .. tab:: Windows

                .. code-block:: bash

                    nwb2bids convert ~/.nwb2bids/tutorials/ephys_tutorial_file/ephys.nwb ^
                        --bids-directory ~/.nwb2bids/tutorials/ephys_tutorial_file/bids_dataset

    .. tab:: Python Library

        .. code-block:: python

            >>> import pathlib
            >>>
            >>> import nwb2bids
            >>>
            >>> tutorial_directory = pathlib.Path.home() / ".nwb2bids/tutorials/ephys_tutorial_file"
            >>> nwb_paths = [tutorial_directory / "ephys.nwb"]
            >>> bids_directory = tutorial_directory / "bids_dataset"
            >>>
            >>> notifications = nwb2bids.convert_nwb_dataset(
            ...     nwb_paths=nwb_paths,
            ...     bids_directory=bids_directory,
            ... )

Notice how we explicitly specified the output BIDS directory in the previous step. We will cover the implicit
(current working directory) approach in  :ref:`tutorial-implicit-bids-directory`.

You can now explore the directory structure and contents of the generated BIDS dataset. You should see something
along the lines of:

.. code-block:: text

    ephys_tutorial_file/bids_dataset/
    ├── dataset_description.json
    ├── participants.tsv
    ├── participants.json
    └── sub-subject+1/
        ├── sub-subject+1_sessions.tsv
        ├── sub-subject+1_sessions.json
        └── ses-session+1/
            └── ecephys/
                ├── sub-subject+1_ses-session+1_ecephys.nwb
                ├── sub-subject+1_ses-session+1_channels.tsv
                ├── sub-subject+1_ses-session+1_channels.json
                ├── sub-subject+1_ses-session+1_electrodes.tsv
                ├── sub-subject+1_ses-session+1_electrodes.json
                ├── sub-subject+1_ses-session+1_probes.tsv
                └── sub-subject+1_ses-session+1_probes.json



.. _tutorial-multiple-files:

Tutorial 2 - Converting directories
-----------------------------------

In case you don't have an entire experiment's worth of NWB files, you can generate an example dataset through the
command line interface (CLI) as follows:

.. tabs::

    .. tab:: CLI

        .. code-block:: bash

            nwb2bids tutorial ephys dataset

        .. tip::

            Lost in the CLI? Can't remember the exact phrase to type when navigating through the command groups? No worries!

            Simply add the ``--help`` to any command to see detailed descriptions, expected inputs, and optional flags.

            You can also see a layout of the command structure by calling each level at a time, for example ``nwb2bids``,
            ``nwb2bids tutorial``, and so on.

            Try it out on ``nwb2bids tutorial`` to see all the types of tutorial data we can generate for you.

    .. tab:: Python Library

        .. code-block:: bash

            import nwb2bids

            nwb2bids.testing.generate_ephys_tutorial(mode="dataset")

        .. tip::

            Lost in the Python library? Can't remember the exact inputs to pass to an imported function? No worries!

            Simply add the ``?`` at the end of any module or function to see a detailed description of imports or
            expected inputs. Try it out on ``nwb2bids?`` to see the library's welcome message.

            The **nwb2bids** library is also designed for easy auto-completion in interactive environments like
            IPython or Jupyter notebooks; try it out on by hitting your tab button after typing ``nwb2bids.testing.`` to
            see all the functions exposed to that submodule.

Now we should have a directory that looks something like:

.. code-block:: text

    ephys_tutorial_dataset/
    ├── ephys_session_3.nwb
    ├── DO_NOT_CONVERT.nwb
    └── some_sessions/
        ├── ephys_session_1.nwb
        └── ephys_session_1.nwb

Now, to convert only the subset of files under `some_sessions/` to BIDS, we can run the following command:

.. tabs::
    .. tab:: CLI

        .. tabs::
            .. tab:: Unix / macOS

                .. code-block:: bash

                    nwb2bids convert ~/.nwb2bids/tutorials/ephys_tutorial_dataset/some_sessions \
                        --bids-directory ~/.nwb2bids/tutorials/ephys_tutorial_dataset/some_sessions_bids_dataset

            .. tab:: Windows

                .. code-block:: bash

                    nwb2bids convert ~/.nwb2bids/tutorials/ephys_tutorial_dataset/some_sessions ^
                        --bids-directory ~/.nwb2bids/tutorials/ephys_tutorial_dataset/some_sessions_bids_dataset

    .. tab:: Python Library

        .. code-block:: python

            >>> import pathlib
            >>>
            >>> import nwb2bids
            >>>
            >>> tutorial_directory = pathlib.Path.home() / ".nwb2bids/tutorials/ephys_tutorial_dataset"
            >>> nwb_paths = [tutorial_directory / "some_sessions"]
            >>> bids_directory = tutorial_directory / "some_sessions_bids_dataset"
            >>>
            >>> notifications = nwb2bids.convert_nwb_dataset(
            ...     nwb_paths=nwb_paths,
            ...     bids_directory=bids_directory,
            ... )

And our BIDS dataset should look like:

.. code-block:: text

    ephys_tutorial_dataset/some_sessions_bids_dataset/
    ├── dataset_description.json
    ├── participants.tsv
    ├── participants.json
    └── sub-subject+1/
        ├── sub-subject+1_sessions.tsv
        ├── sub-subject+1_sessions.json
        ├── ses-session+1/
        │   └── ecephys/
        │       ├── sub-subject+1_ses-session+1_ecephys.nwb
        │       ├── sub-subject+1_ses-session+1_channels.tsv
        │       ├── sub-subject+1_ses-session+1_channels.json
        │       ├── sub-subject+1_ses-session+1_electrodes.tsv
        │       ├── sub-subject+1_ses-session+1_electrodes.json
        │       ├── sub-subject+1_ses-session+1_probes.tsv
        │       └── sub-subject+1_ses-session+1_probes.json
        └── ses-session+2/
            └── ecephys/
                ├── sub-subject+1_ses-session+2_ecephys.nwb
                ├── sub-subject+1_ses-session+2_channels.tsv
                ├── sub-subject+1_ses-session+2_channels.json
                ├── sub-subject+1_ses-session+2_electrodes.tsv
                ├── sub-subject+1_ses-session+2_electrodes.json
                ├── sub-subject+1_ses-session+2_probes.tsv
                └── sub-subject+1_ses-session+2_probes.json



.. _tutorial-multiple-inputs:

Tutorial 3 - Multiple inputs
----------------------------

Using the same example dataset as in :ref:`tutorial-multiple-files`, we will now show how to convert any mix of
individual NWB files and directories containing NWB files.

Attentive readers may have noticed that in the previous tutorial, we only converted the files under `some_sessions/`,
ignoring the other NWB file at the top level (including the one called `DO_NOT_CONVERT.nwb`).

We can select which files and directories to convert like so:

.. tabs::
    .. tab:: CLI

        .. tabs::
            .. tab:: Unix / macOS

                .. code-block:: bash

                    nwb2bids convert \
                        ~/.nwb2bids/tutorials/ephys_tutorial_dataset/ephys_session_3.nwb \
                        ~/.nwb2bids/tutorials/ephys_tutorial_dataset/some_sessions \
                        --bids-directory ~/.nwb2bids/tutorials/ephys_tutorial_dataset/bids_dataset

            .. tab:: Windows

                .. code-block:: bash

                    nwb2bids convert ^
                        ~/.nwb2bids/tutorials/ephys_tutorial_dataset/ephys_session_3.nwb ^
                        ~/.nwb2bids/tutorials/ephys_tutorial_dataset/some_sessions ^
                        --bids-directory ~/.nwb2bids/tutorials/ephys_tutorial_dataset/bids_dataset

        The command line can take any number of inputs (separated by spaces) prior to other flags such as
        ``--bids-directory``. These inputs can be any mix of files or directories.

    .. tab:: Python Library

        .. code-block:: python

            >>> import pathlib
            >>>
            >>> import nwb2bids
            >>>
            >>> tutorial_directory = pathlib.Path.home() / ".nwb2bids/tutorials/ephys_tutorial_dataset"
            >>> nwb_paths = [
            ...     tutorial_directory / "ephys_session_3.nwb",
            ...     tutorial_directory / "some_sessions",
            ... ]
            >>> bids_directory = tutorial_directory / "bids_dataset"
            >>>
            >>> notifications = nwb2bids.convert_nwb_dataset(
            ...     nwb_paths=nwb_paths,
            ...     bids_directory=bids_directory,
            ... )

Our resulting BIDS dataset should now contain all three NWB files converted to BIDS:

.. code-block:: text

    ephys_tutorial_dataset/bids_dataset/
    ├── dataset_description.json
    ├── participants.tsv
    ├── participants.json
    ├── sub-subject+1/
    │   ├── sub-subject+1_sessions.tsv
    │   ├── sub-subject+1_sessions.json
    │   ├── ses-session+1/
    │   │   └── ecephys/
    │   │       ├── sub-subject+1_ses-session+1_ecephys.nwb
    │   │       ├── sub-subject+1_ses-session+1_channels.tsv
    │   │       ├── sub-subject+1_ses-session+1_channels.json
    │   │       ├── sub-subject+1_ses-session+1_electrodes.tsv
    │   │       ├── sub-subject+1_ses-session+1_electrodes.json
    │   │       ├── sub-subject+1_ses-session+1_probes.tsv
    │   │       └── sub-subject+1_ses-session+1_probes.json
    │   └── ses-session+2/
    │       └── ecephys/
    │           ├── sub-subject+1_ses-session+2_ecephys.nwb
    │           ├── sub-subject+1_ses-session+2_channels.tsv
    │           ├── sub-subject+1_ses-session+2_channels.json
    │           ├── sub-subject+1_ses-session+2_electrodes.tsv
    │           ├── sub-subject+1_ses-session+2_electrodes.json
    │           ├── sub-subject+1_ses-session+2_probes.tsv
    │           └── sub-subject+1_ses-session+2_probes.json
    └── sub-subject+2/
        ├── sub-subject+2_sessions.tsv
        ├── sub-subject+2_sessions.json
        └── ses-session+3/
            └── ecephys/
                ├── sub-subject+2_ses-session+3_ecephys.nwb
                ├── sub-subject+2_ses-session+3_channels.tsv
                ├── sub-subject+2_ses-session+3_channels.json
                ├── sub-subject+2_ses-session+3_electrodes.tsv
                ├── sub-subject+2_ses-session+3_electrodes.json
                ├── sub-subject+2_ses-session+3_probes.tsv
                └── sub-subject+2_ses-session+3_probes.json



.. _tutorial-implicit-bids-directory:

Tutorial 4 - Implicit BIDS directory
------------------------------------

In the previous tutorials we have always specified the target BIDS directory as an explicit path. It is also possible
to use the current working directory as the BIDS directory, provided that it is either empty or already a partial BIDS
dataset as defined by a ``dataset_description.json`` file with a ``BIDSVersion`` value specified within.

To test this out, we can create a new empty directory and navigate into it before converting:

.. tabs::
    .. tab:: CLI

        .. tabs::
            .. tab:: Unix / macOS

                .. code-block:: bash

                    mkdir ~/.nwb2bids/tutorials/ephys_tutorial_dataset/bids_dataset
                    cd ~/.nwb2bids/tutorials/ephys_tutorial_dataset/bids_dataset

                    nwb2bids convert \
                        ~/.nwb2bids/tutorials/ephys_tutorial_dataset/ephys_session_3.nwb \
                        ~/.nwb2bids/tutorials/ephys_tutorial_dataset/some_sessions

            .. tab:: Windows

                .. code-block:: bash

                    mkdir ~/.nwb2bids/tutorials/ephys_tutorial_dataset/bids_dataset
                    cd ~/.nwb2bids/tutorials/ephys_tutorial_dataset/bids_dataset

                    nwb2bids convert ^
                        ~/.nwb2bids/tutorials/ephys_tutorial_dataset/ephys_session_3.nwb ^
                        ~/.nwb2bids/tutorials/ephys_tutorial_dataset/some_sessions

        The command line can take any number of inputs (separated by spaces) prior to other flags such as
        ``--bids-directory``. These inputs can be any mix of files or directories.

    .. tab:: Python Library

        .. code-block:: python

            >>> import os
            >>> import pathlib
            >>>
            >>> import nwb2bids
            >>>
            >>> tutorial_directory = pathlib.Path.home() / ".nwb2bids/tutorials/ephys_tutorial_dataset"
            >>> nwb_paths = [
            ...     tutorial_directory / "ephys_session_3.nwb",
            ...     tutorial_directory / "some_sessions",
            ... ]
            >>> bids_directory = tutorial_directory / "implicit_bids_dataset"
            >>> bids_directory.mkdir(exist_ok=True)
            >>> os.chdir(path=bids_directory)
            >>>
            >>> notifications = nwb2bids.convert_nwb_dataset(nwb_paths=nwb_paths)

And the results should match what we saw at the end of :ref:`tutorial-multiple-inputs`.



.. _tutorial-additional-metadata:

Tutorial 5 - Additional metadata
---------------------------------

NWB files don't always include all the little metadata details you might want to include in BIDS. To include manual
metadata that is unable to be extracted from the source files, you can provide additional metadata through a JSON
structure that mirrors the BIDS specification nested under subject and session identifiers (which should match the
``subject_id`` and ``session_id`` found within each file).

To show how such additional metadata can be included through **nwb2bids**, start by creating a file named
``metadata.json`` inside the ``ephys_tutorial_dataset`` directory we used in :ref:`tutorial-multiple-files`.
Then fill the contents of the file to match below:

.. code-block:: json

    {
        "dataset_description": {
            "Name": "My Custom BIDS Dataset",
            "BIDSVersion": "1.8.0",
            "Authors": ["First Last", "Second Author"]
        }
    }

To include this additional metadata during conversion, we can use the following commands:

.. tabs::
    .. tab:: CLI

        .. tabs::
            .. tab:: Unix / macOS

                .. code-block:: bash

                    nwb2bids convert ~/.nwb2bids/tutorials/ephys_tutorial_file/ephys.nwb \
                        --bids-directory ~/.nwb2bids/tutorials/ephys_tutorial_file/bids_dataset \
                        --additional-metadata-file-path ~/.nwb2bids/tutorials/ephys_tutorial_file/metadata.json

            .. tab:: Windows

                .. code-block:: bash

                    nwb2bids convert ~/.nwb2bids/tutorials/ephys_tutorial_file/ephys.nwb ^
                        --bids-directory ~/.nwb2bids/tutorials/ephys_tutorial_file/bids_dataset ^
                        --additional-metadata-file-path ~/.nwb2bids/tutorials/ephys_tutorial_file/metadata.json

    .. tab:: Python Library

        .. code-block:: python

            >>> import pathlib
            >>>
            >>> import nwb2bids
            >>>
            >>> tutorial_directory = pathlib.Path.home() / ".nwb2bids/tutorials/ephys_tutorial_file"
            >>> nwb_paths = [tutorial_directory / "ephys.nwb"]
            >>> bids_directory = tutorial_directory / "bids_dataset"
            >>> additional_metadata_file_path = tutorial_directory / "metadata.json"
            >>>
            >>> notifications = nwb2bids.convert_nwb_dataset(
            ...     nwb_paths=nwb_paths,
            ...     bids_directory=bids_directory,
            ...     additional_metadata_file_path=additional_metadata_file_path,
            ... )

.. note::

    Currently only ``dataset_description`` metadata is supported, but more detailed subject- and session-level
    metadata will be supported in the future.



.. _tutorial-library-customization:

Tutorial 6 - Library customization
----------------------------------

The **nwb2bids** Python library is much easier to customize and interact with than the CLI usage.

The workflow that is automatically run by the helper function :func:`~nwb2bids.convert_nwb_dataset()` can be
broken down into the following distinct steps:

.. code-block:: python

    >>> import nwb2bids
    >>>
    >>> tutorial_directory = pathlib.Path.home() / ".nwb2bids/tutorials/ephys_tutorial_file"
    >>> nwb_paths = [tutorial_directory / "ephys.nwb"]
    >>> bids_directory = tutorial_directory / "bids_dataset"
    >>> additional_metadata_file_path = tutorial_directory / "metadata.json"
    >>>
    >>> # Step 1: Initialize the DatasetConverter object
    >>> converter = nwb2bids.DatasetConverter.from_nwb_paths(
    ...     nwb_paths=nwb_paths,
    ...     additional_metadata_file_path=additional_metadata_file_path,
    ... )
    >>>
    >>> # Step 2: Extract metadata from NWB contents
    >>> converter.extract_metadata()
    >>>
    >>> # Step 3: Convert NWB files to BIDS structure
    >>> converter.convert_to_bids_dataset(bids_directory=bids_directory)

The ``converter`` object (a type of :class:`~nwb2bids.DatasetConverter`) exposes many useful attributes and methods
that may useful to explore. In particular, it contains all of the :class:`~nwb2bids.SessionConverter` objects that were
assembled from the input NWB files. These in turn attach various metadata models,
such as :class:`~nwb2bids.bids_models.BidsSessionMetadata`, from which all metadata attributes used during the BIDS
conversion process may be inspected and modified prior to writing the resulting files.



.. _tutorial-future:

More tutorials coming soon!
---------------------------

We are still compiling some detailed tutorials for more advanced use cases, such as sanitization, run configurations,
non-ephys data types, and more!

Check back soon for updates.
